<html>
<head>
    <meta charset="UTF-8">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <title>きりはりくん編集画面</title>
    <style type="text/css">
    	button {cursor: pointer;}
    	#body{min-height: 100%}
    	#video{max-width: 100%;}
    </style>
</head>
<body onload="init();">
	<div class="container">
		<h3 style="margin: 1em 0 1em 0;">動画をカット編集</h3>
		<video id="video" controls=""></video>
		<div id="cutsbar"></div>
        <h4 style="margin: 1em 0">プロジェクトの設定</h4>
        <div class="form-group">
            <div class="form-inline">
                <span class="input-group-addon">幅</span>
                <input type="number" class="form-control" id="pwidth" value="1280" />
                <span class="input-group-addon">高さ</span>
                <input type="number" class="form-control" id="pheight" value="720" />
            </div>
            <div class="form-inline mt-1">
                <select class="form-control" id="selsize">
                    <option value="1080">1920 * 1080 (1080p)</option>
                    <option value="720" selected="">1280 * 720 (720p)</option>
                    <option value="540">960 * 540</option>
                    <option value="360">640 * 360 (360p)</option>
                </select>
            </div>
        </div>
        <div class="mt-1 form-inline">
            <span class="input-group-addon">フレームレート</span>
            <input type="number" class="form-control" id="pfps" value="60" />
        </div>
        <div class="form-inline mt-1">
            <select class="form-control" id="selfps">
                <option value="60" selected="">60 fps</option>
                <option value="30">30 fps</option>
                <option value="29.97">29.97 fps</option>
            </select>
        </div>
        <h4 style="margin: 2em 0 1em 0">動画のプロパティ</h4>
        <table id="infotable" style="margin-top: 1em"></table>

        <footer style="margin-top: 3em">
            <p>HTML5, Javascript, LocalStorageを使用しています。一部のブラウザでは動作しない可能性があります。<br>&copy; 2018 fine_diary, all rights reserved. Powered by <a href="https://jquery.com/" target="_blank">jQuery</a>, <a href="https://getbootstrap.com/" target="_blank">bootstrap</a></p>
        </footer>
	</div>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="data.js"></script>
    <script type="text/javascript">
    	var project_width	= 1280;
    	var project_height	= 720;
    	var project_fps		= 60;
    	var audio_rate		= 44100;

    	var filename, nb_frames, width, height, r_frame_rate, duration, size;

		function init(){
            var l1 = localStorage.getItem('pwidth');
            if (l1)  $('#pwidth').val(l1);
            var l2 = localStorage.getItem('pheight');
            if (l2) $('#pheight').val(l2);
            var l3 = localStorage.getItem('pfps');
            if (l3) $('#pfps').val(l3);
            var l4 = localStorage.getItem('selfps');
            if (l4) $('#selfps').val(l4);
            var l5 = localStorage.getItem('selsize');
            if (l5) $('#selsize').val(l5);

			var m = JAVA_QUERY.replace(/&apos;/g, "'").match(/[^?&]+=[^?&]*/g);

			if (m){
				for (var i = 0; i < m.length; i++) {
					var s = m[i].split('=');
					if (s[0] === 'filename'){
						filename = s[1];
					} else if (s[0] === 'r_frame_rate') {
						if (s[1] === '0/0'){
							r_frame_rate = 'VFR';
						} else {
							var a = s[1].split('%2F');
							if (a.length == 2){
								r_frame_rate = parseInt(a[0], 10) / parseInt(a[1], 10);
							}
						}
					} else if (s[0] === 'nb_frames') {
						nb_frames = parseInt(s[1], 10);
					} else if (s[0] === 'width') {
						width = parseInt(s[1], 10);
					} else if (s[0] === 'height') {
						height = parseInt(s[1], 10);
					} else if (s[0] === 'duration') {
						duration = parseInt(s[1], 10);
					} else if (s[0] === 'size'){
						size = parseInt(s[1], 10);
					}
				}
			}

			if (filename) {
				$('#video').append($('<source>', {
					'src': unescape(filename)
				}));
			}

			var table = $('<table>', {'class': 'table'});
			var tr1 = tr('ファイルのパス', filename);
			var tr2 = tr('総フレーム数', nb_frames);
			var tr3 = tr('幅', width);
			var tr4 = tr('高さ', height);
			var tr5 = tr('フレームレート', r_frame_rate);
			var tr6 = tr('長さ', durationString(duration));
			var tr7 = tr('ファイルサイズ', sizeString(size));
			table.append(tr1);
			table.append(tr2);
			table.append(tr3);
			table.append(tr4);
			table.append(tr5);
			table.append(tr6);
			table.append(tr7);
			$('#infotable').append(table);
		}

        function sizeString(byte){
            if (byte < 100){
                return byte + " byte";
            } else if (byte < 100000){
                var a = Math.round( byte * 1000 / 1024 ) / 1000;
                return a + " KB";
            } else {
                var a = Math.round( (byte * 1000 / 1024) / 1024 ) / 1000;
                return a + " GB";
            }
        }

        function durationString(ms){
            if (ms < 1000*60){
                var a = Math.round( ms * 1000 ) / 1000;
                return a + " s";
            } else if (ms < 1000*60*60) {
                var a = Math.round(ms/60000);
                var b = Math.round((ms-a*60000)/1000);
                return a + " m " + b + " s";
            } else {
                var a = Math.round(ms/3600000);
                var b = Math.round((ms-a*3600000)/60000);
                var c = Math.round((ms-a*3600000-b*60000)/1000);
                return a + " h " + b + " m " + c + " s";
            }
        }

		function tr(a, b){
			var tr = $('<tr>');
			var td1 = $('<td>', {text:a});
			var td2 = $('<td>', {text:b});
			tr.append(td1);
			tr.append(td2);
			return tr;
		}

        $('#selsize').on('change', function(){
            var val = $('#selsize').val();
            if (val == "1080"){
                $('#pwidth').val(1920);
                $('#pheight').val(1080);
            } else if (val == "720"){
                $('#pwidth').val(1280);
                $('#pheight').val(720);
            } else if (val == "360"){
                $('#pwidth').val(640);
                $('#pheight').val(360);
            } else if (val == "540"){
                $('#pwidth').val(960);
                $('#pheight').val(540);
            }
            $('#pwidth').on('click');
            $('#pheight').on('click');
            localStorage.setItem('selsize', $('#selsize').val());
        });
        $('#selfps').on('change', function(){
            var val = $('#selsize').val();
            if (val == "60"){
                $('#pfps').val(60);
            } else if (val == "30"){
                $('#pfps').val(30);
            } else if (val == "29.97"){
                $('#pfps').val(29,.97);
            }
            $('#pfps').on('click');
            localStorage.setItem('selfps', $('#selfps').val());
        });

        $('#pwidth').on('change', function(){
            localStorage.setItem('pwidth', $('#pwidth').val());
        });
        $('#pheight').on('change', function(){
            localStorage.setItem('pheight', $('#pheight').val());
        });
        $('#pfps').on('change', function(){
            localStorage.setItem('pfps', $('#pfps').val());
        });

    	var cuts_example = [
	    	{
	    		"pos_start"   : 1,
	    		"pos_end"     : 204,
	    		"video_start" : 1
	    	},
	    	{
	    		"pos_start"   : 205,
	    		"pos_end"     : 80812,
	    		"video_start" : 300
	    	}
	    ];

    	function issueExo(){
    		var cuts = parsePositions();
    		var mgn = 100;
    		var exofilename = 'unnamed.exo';
    		var abspath = getVideoURIAsAbsPath();
    		var total_length = 0;
    		var a = [];
    		var v = [];

            project_width = parseInt($('#pwidth').val(), 10);
            project_height = parseInt($('#pheight').val(), 10);
            project_fps = parseInt($('#pfps').val(), 10);

    		for (var i = 0; i < cuts.length; i++) {
    			var cut = cuts[i];

    			total_length += cut["pos_end"] - cut["pos_start"] + 1;

    			v.push('['+i+']');
    			v.push('start='+cut["pos_start"]);
    			v.push('end='+cut["pos_end"]);
    			v.push('layer=1');
    			v.push('group=1');
    			v.push('overlay=1');
    			v.push('camera=0');

    			v.push('['+i+'.0]');
    			v.push('_name=動画ファイル');
    			v.push('再生位置='+cut["video_start"]);
    			v.push('再生速度=100.0');
    			v.push('ループ再生=0');
    			v.push('アルファチャンネルを読み込む=0');
    			v.push('file='+abspath);

    			v.push('['+i+'.1]');
    			v.push('_name=標準描画');
    			v.push('X=0.0');
    			v.push('Y=0.0');
    			v.push('Z=0.0');
    			v.push('拡大率='+mgn);
    			v.push('透明度=0.0');
    			v.push('回転=0.00');
    			v.push('blend=0');

    			a.push('['+(cuts.length+i)+']');
    			a.push('start='+cut["pos_start"]);
    			a.push('end='+cut["pos_end"]);
    			a.push('layer=2');
    			a.push('group=1');
    			a.push('overlay=1');
    			a.push('audio=1');

    			a.push('['+(cuts.length+i)+'.0]');
    			a.push('_name=音声ファイル');
    			a.push('再生位置='+cut["video_start"]);
    			a.push('再生速度='+mgn);
    			a.push('ループ再生=0');
    			a.push('動画ファイルと連携=1');
    			a.push('file='+abspath);

    			a.push('['+(cuts.length+i)+'.1]');
    			a.push('_name=標準再生');
    			a.push('音量=100.0');
    			a.push('左右=0.0');
    		}

    		var o = [];
    		o.push('[exedit]');
    		o.push('width='+preference["project_width"]);
    		o.push('height='+preference["project_height"]);
    		o.push('rate='+preference["frame_rate"]);
    		o.push('scale=1');
    		o.push('length='+total_length);
    		o.push('audio_rate='+preference["audio_rate"]);
    		o.push('audio_ch=2');

    		var exotext = o.join('\n') + '\n' + v.join('\n') + '\n' + a.join('\n');

    		//eel.makefile(exofilename, exotext);

    		//saveas(exofilename, exotext)
    	}

    	function getVideoURIAsAbsPath(){
    		if (filepath.match(/^file:\/\/\//)){
    			return filepath.replace(/^file:\/\/\//, "").replace(/\//g, "\\");
    		} else {
    			return filepath;
    		}
    	}

    	function getVideoURIAsFilePrtclPath(){
    		if (!filepath.match(/^file:\/\/\//)){
    			return "file:///"+filepath.replace(/\\/g, "/");
    		} else {
    			return filepath;
    		}
    	}

    	$('#video').on('click', function(e){
    		videoPlayPause();
    	});

    	function videoPlayPause(){
    		var v = $('#video').get(0);
    		if (v.paused) {
			    v.play(); 
    		} else {
				v.pause(); 
    		}
    	}

    	var positions = [];

    	function setCurrentTimeAsStartOrEnd(){
    		var currentTime = $('#video').get(0).currentTime;
    		positions.push(currentTime);
    	}

    	function parsePositions(){
    		var _cuts = [];
    		var r = positions.length % 2;
    		var frames = 1;
    		for (var i = 0; i < (positions.length-r)/2; i++) {
    			var startframe = Math.round(positions[2*i] * project_fps);
    			var endframe = Math.round(positions[2*i+1] * project_fps);

		    	var cut = {
		    		"pos_start"   : frames,
		    		"pos_end"     : frames + endframe - startframe,
		    		"video_start" : startframe
		    	}
		    	_cuts.push(cut);

    			frames += endframe - startframe;
    		}
    		if (r === 1){
    			var startframe = Math.round(positions[positions.length-1] * project_fps);
    			var endframe = Math.round($('#video').get(0).duration * project_fps);

		    	var cut = {
		    		"pos_start"   : frames,
		    		"pos_end"     : frames + endframe - startframe,
		    		"video_start" : startframe
		    	}
		    	_cuts.push(cut);
    		}
    		return cuts;
    	}

    	var Keybind = function(id, keycode, ctrl, shift, alt, onkeypress){
    		this.id = id;
    		this.keycode = keycode;
    		this.ctrl = ctrl;
    		this.shift = shift;
    		this.alt = alt;
    		this.onkeypress = onkeypress;
    	}

    	Keybind.prototype.call = function(){
    		this.onkeypress();
    	};

    	Keybind.prototype.iskeypressed = function(event){
    		if (this.keycode !== event.keyCode) return false;
    		if (this.ctrl && !event.ctrlKey) return false;
    		if (this.shift && !event.shiftKey) return false;
    		if (this.alt && !event.altKey) return false;
    		return true;
    	};

    	Keybind.prototype.setkeycode = function(keycode){
    		this.keycode = keycode;
    	};

    	var keybinds = [
    		new Keybind("vpp", 32, false, false, false, videoPlayPause),
    		new Keybind("sctasoe", 13, false ,false, false, setCurrentTimeAsStartOrEnd),
    		new Keybind("ie", 83, true, false, false, issueExo)
    	];

    	$('body').on('keypress', function(e){
    		for (var i = 0; i < keybinds.length; i++) {
    			if (keybinds[i].iskeypressed(e)){
    				e.preventDefault();
    				keybinds[i].call();
    			}
    		}
    	});

    	/*
			function download(data, filename, type) {
			    var file = new Blob([data], {type: type});
			    if (window.navigator.msSaveOrOpenBlob) // IE10+
			        window.navigator.msSaveOrOpenBlob(file, filename);
			    else { // Others
			        var a = document.createElement("a"),
			                url = URL.createObjectURL(file);
			        a.href = url;
			        a.download = filename;
			        document.body.appendChild(a);
			        a.click();
			        setTimeout(function() {
			            document.body.removeChild(a);
			            window.URL.revokeObjectURL(url);  
			        }, 0); 
			    }
			}

			https://stackoverflow.com/questions/13405129/javascript-create-and-save-file
    	*/

    	/*
			http://aviutl.info/sagyou-hozonn/#exo
			https://stackoverflow.com/questions/20097853/obtain-the-duration-of-a-mp4-file
			http://ffmpeg.org/ffprobe.html
			https://stackoverflow.com/questions/32210057/how-to-read-metadata-from-mp4-using-mp4-js-node-module
			https://stackoverflow.com/questions/3844430/how-to-get-the-duration-of-a-video-in-python
		*/
		/*
			TODO:
			- seek bar which can be interacted and show cut position
			- indicator which pops when hotkey pressed
			- save-file prompt ( just for windows user )
			- keybind settings
			- save / load edit
			- menu bar
		*/
    </script>
</body>
</html>