<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <title>きりはりくん編集画面</title>
    <style type="text/css">
        button {cursor: pointer;}
        #body{min-height: 100%}
        #video{max-width: 100%;}
    </style>
</head>
<body onload="init();">
    <div class="container">
        <h3 style="margin: 1em 0 1em 0;">動画をカット編集</h3>
        <video id="video" controls=""></video>
        <div id="cutsbar"></div>
        <div class="progress mt-1">
			<div class="progress-bar progress-bar-striped" style="width: 15.51234%"></div>
		</div>
        <h4 style="margin: 1em 0">プロジェクトの設定</h4>
        <div class="form-group">
            <div class="form-inline">
                <span class="input-group-addon">幅</span>
                <input type="number" class="form-control" id="pwidth" value="1280" />
                <span class="input-group-addon">高さ</span>
                <input type="number" class="form-control" id="pheight" value="720" />
            </div>
            <div class="form-inline mt-1">
                <select class="form-control" id="selsize">
                    <option value="1080">1920 * 1080 (1080p)</option>
                    <option value="720" selected="">1280 * 720 (720p)</option>
                    <option value="540">960 * 540</option>
                    <option value="360">640 * 360 (360p)</option>
                </select>
            </div>
        </div>
        <div class="mt-1 form-inline">
            <span class="input-group-addon">フレームレート</span>
            <input type="number" class="form-control" id="pfps" value="60" />
        </div>
        <div class="form-inline mt-1">
            <select class="form-control" id="selfps">
                <option value="60" selected="">60 fps</option>
                <option value="30">30 fps</option>
                <option value="29.97">29.97 fps</option>
            </select>
        </div>
        <h4 style="margin: 2em 0 1em 0">動画のプロパティ</h4>
        <table id="infotable" style="margin-top: 1em"></table>

        <footer style="margin-top: 3em;font-size: .8em">
            <p>HTML5, Javascript, LocalStorageを使用しています。一部のブラウザでは動作しない可能性があります。<br>&copy; 2018 fine_diary, all rights reserved. Powered by <a href="https://jquery.com/" target="_blank">jQuery</a>, <a href="https://getbootstrap.com/" target="_blank">bootstrap</a></p>
        </footer>
    </div>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="data.js"></script>
    <script type="text/javascript" src="components.js"></script>
    <script type="text/javascript">
        var project_width      = 1280;
        var project_height     = 720;
        var project_fps        = 60;
        var project_audio_rate = 44100;

		var keybinds = [
		    new Keybind ("vpp",     32, false, false, false, videoPlayPause             ),
		    new Keybind ("sctasoe", 13, false, false, false, setCurrentTimeAsStartOrEnd ),
		    new Keybind ("ie",      83, true,  false, false, issueExo                   )
		];

        var scene_array = [];

        var filename, nb_frames, width, height, r_frame_rate, duration, size;

        function init(){
            // load local storage data
            var l1 = localStorage.getItem('krhr_pwidth');
            if (l1) $('#pwidth') .val(l1);
            var l2 = localStorage.getItem('krhr_pheight');
            if (l2) $('#pheight').val(l2);
            var l3 = localStorage.getItem('krhr_pfps');
            if (l3) $('#pfps')   .val(l3);
            var l4 = localStorage.getItem('krhr_selfps');
            if (l4) $('#selfps') .val(l4);
            var l5 = localStorage.getItem('krhr_selsize');
            if (l5) $('#selsize').val(l5);

			// load video metadata
            var m = JAVA_QUERY.replace(/&apos;/g, "'").match(/[^?&]+=[^?&]*/g);
            if (m){
                for (var i = 0; i < m.length; i++) {
                    var s = m[i].split('=');
                    if (s[0] === 'filename'){
                        filename = s[1];
                    } else if (s[0] === 'nb_frames') {
                        nb_frames = parseInt(s[1], 10);
                    } else if (s[0] === 'width') {
                        width = parseInt(s[1], 10);
                    } else if (s[0] === 'height') {
                        height = parseInt(s[1], 10);
                    } else if (s[0] === 'duration') {
                        duration = parseInt(s[1], 10);
                    } else if (s[0] === 'size'){
                        size = parseInt(s[1], 10);
                    } else if (s[0] === 'r_frame_rate') {
                        if (s[1] === '0/0'){
                            r_frame_rate = 'VFR';
                        } else {
                            var a = s[1].split('/');
                            if (a.length == 2){
                                r_frame_rate = parseInt(a[1], 10) / parseInt(a[0], 10);
                            }
                        }
                    }
                }
            }

            // set video source
            if (filename) {
                $('#video').append($('<source>', {
                    'src': unescape(filename)
                }));
            }

            var table = $('<table>', {'class': 'table'});
            var tr1 = tr('ファイルのパス', filename);
            var tr2 = tr('総フレーム数', nb_frames);
            var tr3 = tr('幅', width);
            var tr4 = tr('高さ', height);
            var tr5 = tr('フレームレート', r_frame_rate);
            var tr6 = tr('長さ', durationString(duration));
            var tr7 = tr('ファイルサイズ', sizeString(size));
            table.append(tr1);
            table.append(tr2);
            table.append(tr3);
            table.append(tr4);
            table.append(tr5);
            table.append(tr6);
            table.append(tr7);
            $('#infotable').append(table);
        }

        // return table row jQuery element
        function tr(a, b){
            var tr = $('<tr>');
            var td1 = $('<td>', {text:a});
            var td2 = $('<td>', {text:b});
            tr.append(td1);
            tr.append(td2);
            return tr;
        }

        $('#selsize').on('change', function(){
            var val = $('#selsize').val();
            if (val == "1080"){
                $('#pwidth').val(1920);
                $('#pheight').val(1080);
            } else if (val == "720"){
                $('#pwidth').val(1280);
                $('#pheight').val(720);
            } else if (val == "360"){
                $('#pwidth').val(640);
                $('#pheight').val(360);
            } else if (val == "540"){
                $('#pwidth').val(960);
                $('#pheight').val(540);
            }
            $('#pwidth').on('click');
            $('#pheight').on('click');
            localStorage.setItem('krhr_selsize', $('#selsize').val());
        });
        $('#selfps').on('change', function(){
            var val = $('#selsize').val();
            if (val == "60"){
                $('#pfps').val(60);
            } else if (val == "30"){
                $('#pfps').val(30);
            } else if (val == "29.97"){
                $('#pfps').val(29,.97);
            }
            $('#pfps').on('click');
            localStorage.setItem('krhr_selfps', $('#selfps').val());
        });
        $('#pwidth').on('change', function(){
            localStorage.setItem('krhr_pwidth', $('#pwidth').val());
        });
        $('#pheight').on('change', function(){
            localStorage.setItem('krhr_pheight', $('#pheight').val());
        });
        $('#pfps').on('change', function(){
            localStorage.setItem('krhr_pfps', $('#pfps').val());
        });

        $('#video').on('click', function(e){
            videoPlayPause();
        });

        function issueExo(){
            var cut_array = [];
            var extension_rate = [];
            var exo_content = exo(filename, cut_array, project_width, project_height, project_fps, project_audio_rate, extension_rate);
            promptWinExplorer('unnamed.exo', exo_content);
        }

        function promptWinExplorer(fileanme, content){
            var file = new Blob([content], {type: 'text/plane'});
            if (window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveOrOpenBlob(file, filename);
            } else {
                var a = document.createElement('a');
                var url = URL.createObjectURL(file);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function() {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);  
                }, 0); 
            }
        }

        function videoPlayPause(){
            var v = $('#video').get(0);
            if (v.paused) {
                v.play(); 
            } else {
                v.pause(); 
            }
        }

        function startCut(){
            var currentTime = $('#video').get(0).currentTime;
            //
        }

        function endCut(){

        }

        function addPositions(){

        }

        $('body').on('keypress', function(e){
            for (var i = 0; i < keybinds.length; i++) {
                if (keybinds[i].iskeypressed(e)){
                    e.preventDefault();
                    keybinds[i].call();
                }
            }
        });

        /*
            TODO:
            - 編集のタイムラインバーに目盛り追加・操作可能・右クリックメニュー
            - ホットキーが押されたときにインジケータ表示
            - Windows専用Downloadプロンプト
            - キーバインド設定
            - 編集内容を一時保存・ロード。exoとして保存
            - メニューバー
            - * 音量設定
            - 拡大率設定 / 自動拡大率設定 ( 画面いっぱいに動画が来るように )
            - AviUtl exeditのtimelineと同じ要領でカット+右クリで削除
            - またはホットキーでpositionのみ記録、自動で偶数番ごとのonair/offair判定。
            - 上２つをモード切替
        */
    </script>
</body>
</html>